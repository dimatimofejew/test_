version: '3.9'

services:
  mysql:
    image: mysql
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  php:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: php
    restart: always
    environment:
      APP_ENV: ${APP_ENV}
      APP_SECRET: ${APP_SECRET}
    volumes:
      - ./app:/var/www/symfony
    depends_on:
      - mysql

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: always
    ports:
      - "${NGINX_PORT}:${NGINX_PORT}"
    volumes:
      - ./nginx:/etc/nginx/templates/
      - ./app:/var/www/symfony
    environment:
      NGINX_ENVSUBST_TEMPLATE_SUFFIX: ".conf"
      DOMAIN: ${DOMAIN}
      NGINX_PORT: ${NGINX_PORT}
      APP_ENV: ${APP_ENV}
    depends_on:
      - php

  sphinx:
    container_name: sphinx
    image: manticoresearch/manticore
    environment:
      - EXTRA=1
    restart: always
    ports:
        - 127.0.0.1:9306:9306
        - 127.0.0.1:9308:9308
    ulimits:
        nproc: 65535
        nofile:
          soft: 65535
          hard: 65535
        memlock:
          soft: -1
          hard: -1
    volumes:
        - ./sphinx/data:/var/lib/manticore
      #      - ./manticore.conf:/etc/manticoresearch/manticore.conf # uncomment if you use a custom config
    depends_on:
     - php
volumes:
  mysql_data:


